<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Page Title</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="js/slider/nouislider.css" type="text/css">
    <link rel="stylesheet" href="css/style.css" type="text/css">
    <!-- <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script> -->
    <script src="js/jquery-3.3.1.min.js"></script>
    <!-- <script src="https://d3js.org/d3.v4.min.js"></script> -->
    <script src="js/d3/d3.min.js"></script>
    <!-- <script src="https://d3js.org/d3-drag.v1.min.js"></script> -->
    <script src="js/slider/wnumb/wNumb.js"></script>
    <script src="js/slider/nouislider.js"></script>
    <!-- jQuery Serialize Object -->
    <script src="js/jquery.serialize-object.min.js"></script>

    <!-- Favicon -->
    <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png">
    <link rel="manifest" href="/favicon/manifest.json">
    <link rel="mask-icon" href="/favicon/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="theme-color" content="#ffffff">
</head>

<body>
    <form id="contact" method="POST" action="">
        <input type="hidden" name="type" value="Battle" id="type">
        <input type="hidden" name="geometry[types]" value="Point" id="geoType">
        <input type="number" name="geometry[coordinates][0]" id="lat" min="0" step="any" required>
        <input type="number" name="geometry[coordinates][1]" id="lng" min="0" step="any" required>
        <input type="text" name="properties[name]" id="name" required>
        <input type="number" name="properties[deaths]" id="deaths" min="0">
        <input type="number" name="properties[date]" id="date" min="0" required>
        <input type="text" name="properties[source]" id="src">
        <input type="text" name="properties[link]" id="url">
        <input type="text" name="properties[text]" id="text">
        <input type="text" name="properties[img]" id="img">
        <input type="submit">
    </form>

    <script>
        $("#contact").submit(function(e) {
            e.preventDefault();

            var inputData = $('form#contact').serializeObject();
            console.log(inputData);

            d3.json("/data/all_battles_new.json", function(error, datas) {

                var data = datas;
                data.push(inputData);

                for (let i = 0; i < data.length; i++) {
                    data[i].id = "id" + i;

                    if (typeof data[i].geometry.coordinates[0] === 'string' ||
                        typeof data[i].geometry.coordinates[1] === 'string' ||
                        typeof data[i].properties.deaths === 'string' ||
                        typeof data[i].properties.date === 'string') {

                        data[i].geometry.coordinates[0] = Number(data[i].geometry.coordinates[0]);
                        data[i].geometry.coordinates[1] = Number(data[i].geometry.coordinates[1]);
                        data[i].properties.deaths = Number(data[i].properties.deaths);
                        data[i].properties.date = Number(data[i].properties.date);
                    }
                }

                console.log("New", data);

                saveToFile(data);
            });
        });
    </script>

    <script>
        function saveToFile(data) {
            var jsonString = JSON.stringify(data);
            var inputForm = document.getElementById('contact');
            $.ajax({
                url: 'php/save.php',
                data: {
                    'jsonString': jsonString
                },
                type: 'POST',
                success: function() {
                    alert("New record has been added");
                    inputForm.reset();
                }
            });
        }
    </script>
</body>

</html>